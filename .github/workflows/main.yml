name: Generate MikroTik v7 IP Lists

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Process IP Lists
        run: |
          set -e
          
          gen_rsc() {
            local url=$1
            local list_name=$2
            local file_name=$3
            local proto=$4
            
            content=$(curl -sSL --fail "$url")
            
            {
              echo "/$proto firewall address-list remove [find list=\"$list_name\"]"
              echo "/$proto firewall address-list"
              
              if [ "$file_name" = "cn.rsc" ]; then
                echo "add list=\"$list_name\" address=10.10.10.0/25"
              fi
              
              echo "$content" | grep -v '^#' | grep -v '^$' | sed "s|^|add list=\"$list_name\" address=|g"
            } > "$file_name"
          }

          gen_rsc "https://raw.githubusercontent.com/gaoyifan/china-operator-ip/ip-lists/china.txt" "CN" "cn.rsc" "ip"
          gen_rsc "https://raw.githubusercontent.com/gaoyifan/china-operator-ip/ip-lists/chinanet.txt" "China_Telecom" "telecom.rsc" "ip"
          gen_rsc "https://raw.githubusercontent.com/gaoyifan/china-operator-ip/ip-lists/unicom.txt" "China_Unicom" "unicom.rsc" "ip"
          gen_rsc "https://raw.githubusercontent.com/gaoyifan/china-operator-ip/ip-lists/cmcc.txt" "China_Mobile" "cmcc.rsc" "ip"
          gen_rsc "https://raw.githubusercontent.com/gaoyifan/china-operator-ip/ip-lists/cernet.txt" "CERNET" "cernet.rsc" "ip"
          gen_rsc "https://raw.githubusercontent.com/gaoyifan/china-operator-ip/ip-lists/cstnet.txt" "CSTNET" "cstnet.rsc" "ip"
          gen_rsc "https://raw.githubusercontent.com/gaoyifan/china-operator-ip/ip-lists/drpeng.txt" "DrPeng" "drpeng.rsc" "ip"

          gen_rsc "https://raw.githubusercontent.com/gaoyifan/china-operator-ip/ip-lists/china6.txt" "CN6" "cn6.rsc" "ipv6"
          gen_rsc "https://raw.githubusercontent.com/gaoyifan/china-operator-ip/ip-lists/chinanet6.txt" "China_Telecom6" "telecom6.rsc" "ipv6"
          gen_rsc "https://raw.githubusercontent.com/gaoyifan/china-operator-ip/ip-lists/unicom6.txt" "China_Unicom6" "unicom6.rsc" "ipv6"
          gen_rsc "https://raw.githubusercontent.com/gaoyifan/china-operator-ip/ip-lists/cmcc6.txt" "China_Mobile6" "cmcc6.rsc" "ipv6"
          gen_rsc "https://raw.githubusercontent.com/gaoyifan/china-operator-ip/ip-lists/cernet6.txt" "CERNET6" "cernet6.rsc" "ipv6"
          gen_rsc "https://raw.githubusercontent.com/gaoyifan/china-operator-ip/ip-lists/cstnet6.txt" "CSTNET6" "cstnet6.rsc" "ipv6"
          gen_rsc "https://raw.githubusercontent.com/gaoyifan/china-operator-ip/ip-lists/drpeng6.txt" "DrPeng6" "drpeng6.rsc" "ipv6"

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add *.rsc
          git diff --quiet && git diff --staged --quiet || git commit -m "Update IP lists $(date +%Y-%m-%d)"
          git push origin main
